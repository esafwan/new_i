import{D as fe}from"./DetailsIcon-b7ac1f53.js";import{A as ge,E as ve,S as ye,a as he,L as xe,_ as be}from"./SLASection-de3d36dc.js";import{E as Ce}from"./Email2Icon-90bca55a.js";import{C as Ie}from"./CommentIcon-10341c79.js";import{P as G}from"./PhoneIcon-df7b879a.js";import{T as ke}from"./TaskIcon-c007a147.js";import{N as we}from"./NoteModal-2036878e.js";import{W as De}from"./WhatsAppIcon-60b0eaf1.js";import{I as Ve}from"./IndicatorIcon-2e26ac17.js";import{A as ze}from"./ArrowUpRightIcon-b156aad4.js";import{S as Ae}from"./Fields-4d667b5d.js";import{_ as Se,a as $e}from"./LayoutHeader-d3ca6986.js";import{_ as Ue}from"./OrganizationModal-a8e19dc1.js";import{_ as Ee}from"./AssignmentModal-8d3e4385.js";import{s as Me,_ as Be}from"./statuses-cf7e371a.js";import{C as Re}from"./ContactModal-fd543427.js";import{_ as Te}from"./Link-00b86c9a.js";import{_ as H}from"./Section-b30b2258.js";import{_ as Ne}from"./CustomActions-3e5f5139.js";import{s as Fe,c as Le,e as y}from"./index-12263c08.js";import{g as Oe,b as Pe}from"./global-7d1669ca.js";import{o as je}from"./organizations-e15a7320.js";import{i as qe,c as We,w as Ge}from"./settings-01f42b9c.js";import{v as He,x as S,a as Ke,k as h,i as R,r as T,b as l,c as m,u as t,g as v,w as c,l as f,G as Je,e as u,d as n,F as N,I as k,n as $,f as K,t as w,H as J,K as Qe,B as Xe}from"./index-29a91f62.js";import{D as Q}from"./Dropdown-a48e38bc.js";import{_ as Ye}from"./Tabs-a1293733.js";import"./CalendarIcon-bb881b97.js";import"./callLog-1e378f99.js";import"./contacts-d5d98e1c.js";import"./Dropdown-a2a4924b.js";import"./FadedScrollableDiv-9ed81c90.js";import"./FileUploader-ae370410.js";import"./LeadsIcon-aaabb1a8.js";import"./DealsIcon-c7294f54.js";import"./EmailTemplateModal-220c8442.js";import"./TaskModal-4a70befb.js";import"./NestedPopover-620c36ca.js";import"./EditIcon-94a66fee.js";import"./OrganizationsIcon-b4d9134c.js";const Ze={class:"relative flex h-12 items-center justify-between gap-2 py-2.5 pl-5"},ea={class:"absolute right-0"},aa={key:1,class:"flex h-12 items-center justify-between gap-2 border-b px-3 py-2.5"},ta={class:"flex items-center gap-2"},oa={key:2,class:"flex h-full overflow-hidden"},sa={key:0},na={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},la={class:"flex flex-col overflow-y-auto"},ia={key:0,class:"pr-2"},ra={key:1},da={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},ma={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},ca=["onClick"],ua={class:"truncate"},pa={class:"flex items-center"},_a={class:"flex flex-col gap-1.5 text-base text-gray-800"},fa={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},ga={class:"flex items-center gap-3 p-1 py-1.5"},va={key:0,class:"mx-2 h-px border-t border-gray-200"},ya={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},nt={__name:"MobileDeal",props:{dealId:{type:String,required:!0}},setup(X){const{$dialog:Y,makeCall:ha}=Oe(),{organizations:Z,getOrganization:ee}=je(),{statusOptions:ae,getDealStatus:te}=Me(),D=He(),_=X,o=S({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:_.dealId},cache:["deal",_.dealId],onSuccess:a=>{Fe(a),Le(a,{doc:a,$dialog:Y,router:D,updateField:C,createToast:y,deleteDoc:ue,call:k})}});Ke(()=>{o.data||o.fetch()});const U=h(!1),E=h(!1),V=h(!1),M=h({}),oe=R(()=>{var a;return((a=o.data)==null?void 0:a.organization)&&ee(o.data.organization)});function se(a,e,r){e=Array.isArray(a)?"":e,!ne(a,e)&&S({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:_.dealId,fieldname:a,value:e},auto:!0,onSuccess:()=>{o.reload(),U.value=!0,y({title:__("Deal updated"),icon:"check",iconClasses:"text-green-600"}),r==null||r()},onError:s=>{var x;y({title:__("Error updating deal"),text:__((x=s.messages)==null?void 0:x[0]),icon:"x",iconClasses:"text-red-600"})}})}function ne(a,e){var s;let r=o.data.fields_meta||{};return(s=r[a])!=null&&s.reqd&&!e?(y({title:__("Error Updating Deal"),text:__("{0} is a required field",[r[a].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const le=R(()=>{var e;let a=[{label:__("Deals"),route:{name:"Deals"}}];return a.push({label:((e=oe.value)==null?void 0:e.name)||__("Untitled"),route:{name:"Deal",params:{dealId:o.data.name}}}),a}),z=h(0),ie=R(()=>[{name:"Details",label:__("Details"),icon:fe,condition:()=>qe.value},{name:"Activity",label:__("Activity"),icon:ge},{name:"Emails",label:__("Emails"),icon:ve},{name:"Comments",label:__("Comments"),icon:Ie},{name:"Calls",label:__("Calls"),icon:G,condition:()=>We.value},{name:"Tasks",label:__("Tasks"),icon:ke},{name:"Notes",label:__("Notes"),icon:we},{name:"WhatsApp",label:__("WhatsApp"),icon:De,condition:()=>Ge.value}].filter(e=>e.condition?e.condition():!0)),A=S({url:"new_i.api.doc.get_sidebar_fields",cache:["fieldsLayout",_.dealId],params:{doctype:"CRM Deal",name:_.dealId},auto:!0,transform:a=>re(a)});function re(a){return a.forEach(e=>{e.name!="contacts_section"&&e.fields.forEach(r=>{r.name=="organization"&&(r.create=(s,x)=>{M.value.organization_name=s,E.value=!0,x()},r.link=s=>D.push({name:"Organization",params:{organizationId:s}}))})}),a}const B=h(!1),F=h({});function de(a){let e=[{label:__("Delete"),icon:"trash-2",onClick:()=>me(a)}];return a.is_primary||e.push({label:__("Set as Primary Contact"),icon:Xe(Ae,{class:"h-4 w-4"}),onClick:()=>ce(a)}),e}async function L(a){await k("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:_.dealId,contact:a})&&(b.reload(),y({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function me(a){await k("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:_.dealId,contact:a})&&(b.reload(),y({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function ce(a){await k("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:_.dealId,contact:a})&&(b.reload(),y({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const b=S({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:_.dealId},cache:["deal_contacts",_.dealId],auto:!0,onSuccess:a=>{var r;let e=(r=A.data)==null?void 0:r.find(s=>s.name=="contacts_section");e&&(e.contacts=a.map(s=>({name:s.name,full_name:s.full_name,email:s.email,mobile_no:s.mobile_no,image:s.image,is_primary:s.is_primary,opened:!1})))}});function C(a,e,r){se(a,e,()=>{o.data[a]=e,r==null||r()})}async function ue(a){await k("frappe.client.delete",{doctype:"CRM Deal",name:a}),D.push({name:"Deals"})}return(a,e)=>{var O;const r=T("FeatherIcon"),s=T("Button"),x=T("Badge");return l(),m(N,null,[t(o).data?(l(),v(Se,{key:0},{default:c(()=>[u("header",Ze,[n(t($e),{items:le.value},null,8,["items"]),u("div",ea,[n(t(Q),{options:t(ae)("deal",C)},{default:c(({open:i})=>[n(s,{label:t(o).data.status,class:$(t(te)(t(o).data.status).colorClass)},{prefix:c(()=>[n(Ve)]),suffix:c(()=>[n(r,{name:i?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])])])]),_:1})):f("",!0),t(o).data?(l(),m("div",aa,[(l(),v(Je(((O=t(o).data._assignedTo)==null?void 0:O.length)==1?"Button":"div"),null,{default:c(()=>[n(Be,{avatars:t(o).data._assignedTo,onClick:e[0]||(e[0]=i=>V.value=!0)},null,8,["avatars"])]),_:1})),u("div",ta,[t(o).data._customActions?(l(),v(Ne,{key:0,actions:t(o).data._customActions},null,8,["actions"])):f("",!0)])])):f("",!0),t(o).data?(l(),m("div",oa,[n(t(Ye),{modelValue:z.value,"onUpdate:modelValue":e[7]||(e[7]=i=>z.value=i),tabs:ie.value,tablistClass:"!px-3",class:"overflow-auto"},{default:c(({tab:i})=>[i.name=="Details"?(l(),m("div",sa,[t(o).data.sla_status?(l(),v(ye,{key:0,modelValue:t(o).data,"onUpdate:modelValue":e[1]||(e[1]=d=>t(o).data=d),onUpdateField:C},null,8,["modelValue"])):f("",!0),t(A).data?(l(),m("div",na,[u("div",la,[(l(!0),m(N,null,K(t(A).data,(d,pe)=>(l(),m("div",{key:d.label,class:$(["flex flex-col px-2 py-3 sm:p-3",{"border-b":pe!==t(A).data.length-1}])},[n(H,{"is-opened":d.opened,label:d.label},{actions:c(()=>[d.contacts?(l(),m("div",ia,[n(Te,{value:"",doctype:"Contact",onChange:e[2]||(e[2]=g=>L(g)),onCreate:(g,I)=>{F.value={first_name:g,company_name:t(o).data.organization},B.value=!0,I()}},{target:c(({togglePopover:g})=>[n(s,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:I=>g()},null,8,["onClick"])]),_:1},8,["onCreate"])])):f("",!0)]),default:c(()=>{var g,I,P;return[d.fields?(l(),v(he,{key:0,fields:d.fields,modelValue:t(o).data,"onUpdate:modelValue":e[3]||(e[3]=p=>t(o).data=p),onUpdate:C},null,8,["fields","modelValue"])):(l(),m("div",ra,[(g=t(b))!=null&&g.loading&&((P=(I=t(b))==null?void 0:I.data)==null?void 0:P.length)==0?(l(),m("div",da,[n(xe,{class:"h-4 w-4"}),u("span",null,w(a.__("Loading...")),1)])):d.contacts.length?(l(!0),m(N,{key:1},K(d.contacts,(p,j)=>(l(),m("div",{key:p.name},[u("div",{class:$(["px-2 pb-2.5",[j==0?"pt-5":"pt-2.5"]])},[n(H,{"is-opened":p.opened},{header:c(({opened:_e,toggle:q})=>[u("div",ma,[u("div",{class:"flex h-7 items-center gap-2 truncate",onClick:W=>q()},[n(t(Pe),{label:p.full_name,image:p.image,size:"md"},null,8,["label","image"]),u("div",ua,w(p.full_name),1),p.is_primary?(l(),v(x,{key:0,class:"ml-2",variant:"outline",label:a.__("Primary"),theme:"green"},null,8,["label"])):f("",!0)],8,ca),u("div",pa,[n(t(Q),{options:de(p.name)},{default:c(()=>[n(s,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),n(s,{variant:"ghost",onClick:W=>t(D).push({name:"Contact",params:{contactId:p.name}})},{default:c(()=>[n(ze,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),n(s,{variant:"ghost",onClick:W=>q()},{default:c(()=>[n(r,{name:"chevron-right",class:$(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":_e}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:c(()=>[u("div",_a,[u("div",fa,[n(Ce,{class:"h-4 w-4"}),J(" "+w(p.email),1)]),u("div",ga,[n(G,{class:"h-4 w-4"}),J(" "+w(p.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),j!=d.contacts.length-1?(l(),m("div",va)):f("",!0)]))),128)):(l(),m("div",ya,w(a.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):f("",!0)])):(l(),v(be,{key:1,doctype:"CRM Deal",title:i.name,reload:U.value,"onUpdate:reload":e[4]||(e[4]=d=>U.value=d),tabIndex:z.value,"onUpdate:tabIndex":e[5]||(e[5]=d=>z.value=d),modelValue:t(o),"onUpdate:modelValue":e[6]||(e[6]=d=>Qe(o)?o.value=d:null)},null,8,["title","reload","tabIndex","modelValue"]))]),_:1},8,["modelValue","tabs"])])):f("",!0),n(Ue,{modelValue:E.value,"onUpdate:modelValue":e[8]||(e[8]=i=>E.value=i),organization:M.value,"onUpdate:organization":e[9]||(e[9]=i=>M.value=i),options:{redirect:!1,afterInsert:i=>C("organization",i.name,()=>{t(Z).reload()})}},null,8,["modelValue","organization","options"]),n(Re,{modelValue:B.value,"onUpdate:modelValue":e[10]||(e[10]=i=>B.value=i),contact:F.value,options:{redirect:!1,afterInsert:i=>L(i.name)}},null,8,["modelValue","contact","options"]),V.value?(l(),v(Ee,{key:3,modelValue:V.value,"onUpdate:modelValue":e[11]||(e[11]=i=>V.value=i),assignees:t(o).data._assignedTo,"onUpdate:assignees":e[12]||(e[12]=i=>t(o).data._assignedTo=i),doc:t(o).data,doctype:"CRM Deal"},null,8,["modelValue","assignees","doc"])):f("",!0)],64)}}};export{nt as default};
//# sourceMappingURL=MobileDeal-3bca0746.js.map
