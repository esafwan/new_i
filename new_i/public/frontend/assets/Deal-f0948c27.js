import{_ as ze,a as $e,L as De}from"./SidePanelModal-277153d8.js";import{A as Se,E as Ue,_ as Ee,S as Ae,a as Me,L as Ne}from"./SLASection-de3d36dc.js";import{E as Be}from"./EditIcon-94a66fee.js";import{E as ee}from"./Email2Icon-90bca55a.js";import{C as Re}from"./CommentIcon-10341c79.js";import{P as O}from"./PhoneIcon-df7b879a.js";import{T as Te}from"./TaskIcon-c007a147.js";import{N as Le}from"./NoteModal-2036878e.js";import{W as Fe}from"./WhatsAppIcon-60b0eaf1.js";import{I as Oe}from"./IndicatorIcon-2e26ac17.js";import{A as Pe}from"./ArrowUpRightIcon-b156aad4.js";import{S as je}from"./Fields-4d667b5d.js";import{_ as qe,a as We}from"./LayoutHeader-d3ca6986.js";import{_ as Ge}from"./OrganizationModal-a8e19dc1.js";import{_ as He}from"./AssignmentModal-8d3e4385.js";import{s as Ke,_ as Je}from"./statuses-cf7e371a.js";import{C as Qe}from"./ContactModal-fd543427.js";import{_ as Xe}from"./Link-00b86c9a.js";import{_ as ae}from"./Section-b30b2258.js";import{_ as Ye}from"./CustomActions-3e5f5139.js";import{s as Ze,c as ea,e as h,g as aa,h as A,o as ta}from"./index-12263c08.js";import{g as oa,_ as z,b as te}from"./global-7d1669ca.js";import{o as sa}from"./organizations-e15a7320.js";import{q as la,v as na,x as M,a as ia,k as x,i as P,r as j,b as r,c as p,u as t,g,w as i,l as _,d as o,F as q,I as $,G as ra,n as N,K as da,e as c,t as b,f as oe,H as se,B as ma}from"./index-29a91f62.js";import{c as le,w as ca}from"./settings-01f42b9c.js";import{D as ne}from"./Dropdown-a48e38bc.js";import{_ as ua}from"./Tabs-a1293733.js";import"./DragVerticalIcon-2de8ea46.js";import"./CalendarIcon-bb881b97.js";import"./callLog-1e378f99.js";import"./contacts-d5d98e1c.js";import"./Dropdown-a2a4924b.js";import"./FadedScrollableDiv-9ed81c90.js";import"./FileUploader-ae370410.js";import"./LeadsIcon-aaabb1a8.js";import"./DealsIcon-c7294f54.js";import"./EmailTemplateModal-220c8442.js";import"./TaskModal-4a70befb.js";import"./NestedPopover-620c36ca.js";import"./OrganizationsIcon-b4d9134c.js";const pa={key:1,class:"flex h-full overflow-hidden"},_a={class:"flex items-center justify-start gap-5 border-b p-5"},fa={class:"group relative size-12"},ga={class:"flex flex-col gap-2.5 truncate"},va={class:"truncate text-2xl font-medium"},ya={class:"flex gap-1.5"},xa={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},ha={class:"flex flex-col overflow-y-auto"},ba={key:0,class:"pr-2"},Ca={key:1},ka={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},wa={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},Ia=["onClick"],Va={class:"truncate"},za={class:"flex items-center"},$a={class:"flex flex-col gap-1.5 text-base text-gray-800"},Da={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},Sa={class:"flex items-center gap-3 p-1 py-1.5"},Ua={key:0,class:"mx-2 h-px border-t border-gray-200"},Ea={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},xt={__name:"Deal",props:{dealId:{type:String,required:!0}},setup(ie){const{$dialog:re,makeCall:de}=oa(),{organizations:me,getOrganization:ce}=sa(),{statusOptions:ue,getDealStatus:pe}=Ke(),{isManager:_e}=la(),D=na(),f=ie,s=M({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:f.dealId},cache:["deal",f.dealId],onSuccess:a=>{Ze(a),ea(a,{doc:a,$dialog:re,router:D,updateField:I,createToast:h,deleteDoc:we,call:$})}});ia(()=>{s.data||s.fetch()});const B=x(!1),R=x(!1),S=x(!1),U=x(!1),T=x({}),w=P(()=>{var a;return((a=s.data)==null?void 0:a.organization)&&ce(s.data.organization)});function fe(a,e,d){e=Array.isArray(a)?"":e,!ge(a,e)&&M({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:f.dealId,fieldname:a,value:e},auto:!0,onSuccess:()=>{s.reload(),B.value=!0,h({title:__("Deal updated"),icon:"check",iconClasses:"text-green-600"}),d==null||d()},onError:m=>{var C;h({title:__("Error updating deal"),text:__((C=m.messages)==null?void 0:C[0]),icon:"x",iconClasses:"text-red-600"})}})}function ge(a,e){var m;let d=s.data.fields_meta||{};return(m=d[a])!=null&&m.reqd&&!e?(h({title:__("Error Updating Deal"),text:__("{0} is a required field",[d[a].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const ve=P(()=>{var e;let a=[{label:__("Deals"),route:{name:"Deals"}}];return a.push({label:((e=w.value)==null?void 0:e.name)||__("Untitled"),route:{name:"Deal",params:{dealId:s.data.name}}}),a}),E=x(0),ye=P(()=>[{name:"Activity",label:__("Activity"),icon:Se},{name:"Emails",label:__("Emails"),icon:Ue},{name:"Comments",label:__("Comments"),icon:Re},{name:"Calls",label:__("Calls"),icon:O,condition:()=>le.value},{name:"Tasks",label:__("Tasks"),icon:Te},{name:"Notes",label:__("Notes"),icon:Le},{name:"WhatsApp",label:__("WhatsApp"),icon:Fe,condition:()=>ca.value}].filter(e=>e.condition?e.condition():!0)),L=M({url:"new_i.api.doc.get_sidebar_fields",cache:["fieldsLayout",f.dealId],params:{doctype:"CRM Deal",name:f.dealId},auto:!0,transform:a=>xe(a)});function xe(a){return a.forEach(e=>{e.name!="contacts_section"&&e.fields.forEach(d=>{d.name=="organization"&&(d.create=(m,C)=>{T.value.organization_name=m,R.value=!0,C()},d.link=m=>D.push({name:"Organization",params:{organizationId:m}}))})}),a}const F=x(!1),W=x({});function he(a){let e=[{label:__("Delete"),icon:"trash-2",onClick:()=>be(a)}];return a.is_primary||e.push({label:__("Set as Primary Contact"),icon:ma(je,{class:"h-4 w-4"}),onClick:()=>Ce(a)}),e}async function G(a){await $("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:f.dealId,contact:a})&&(v.reload(),h({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function be(a){await $("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:f.dealId,contact:a})&&(v.reload(),h({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function Ce(a){await $("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:f.dealId,contact:a})&&(v.reload(),h({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const v=M({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:f.dealId},cache:["deal_contacts",f.dealId],auto:!0,transform:a=>(a.forEach(e=>{e.opened=!1}),a)});function ke(){var d;let a=(d=v.data)==null?void 0:d.find(m=>m.is_primary),e=a.mobile_no||null;if(!a){A(__("No primary contact set"));return}if(!e){A(__("No mobile number set"));return}de(e)}function I(a,e,d){fe(a,e,()=>{s.data[a]=e,d==null||d()})}async function we(a){await $("frappe.client.delete",{doctype:"CRM Deal",name:a}),D.push({name:"Deals"})}const H=x(null);function Ie(){H.value.emailBox.show=!0}return(a,e)=>{const d=j("FeatherIcon"),m=j("Button"),C=j("Badge");return r(),p(q,null,[t(s).data?(r(),g(qe,{key:0},{"left-header":i(()=>[o(t(We),{items:ve.value},null,8,["items"])]),"right-header":i(()=>{var n;return[t(s).data._customActions?(r(),g(Ye,{key:0,actions:t(s).data._customActions},null,8,["actions"])):_("",!0),(r(),g(ra(((n=t(s).data._assignedTo)==null?void 0:n.length)==1?"Button":"div"),null,{default:i(()=>[o(Je,{avatars:t(s).data._assignedTo,onClick:e[0]||(e[0]=l=>S.value=!0)},null,8,["avatars"])]),_:1})),o(t(ne),{options:t(ue)("deal",I)},{default:i(({open:l})=>[o(m,{label:t(s).data.status,class:N(t(pe)(t(s).data.status).colorClass)},{prefix:i(()=>[o(Oe)]),suffix:i(()=>[o(d,{name:l?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])]}),_:1})):_("",!0),t(s).data?(r(),p("div",pa,[o(t(ua),{modelValue:E.value,"onUpdate:modelValue":e[4]||(e[4]=n=>E.value=n),tabs:ye.value},{default:i(({tab:n})=>[o(Ee,{ref_key:"activities",ref:H,doctype:"CRM Deal",title:n.name,reload:B.value,"onUpdate:reload":e[1]||(e[1]=l=>B.value=l),tabIndex:E.value,"onUpdate:tabIndex":e[2]||(e[2]=l=>E.value=l),modelValue:t(s),"onUpdate:modelValue":e[3]||(e[3]=l=>da(s)?s.value=l:null)},null,8,["title","reload","tabIndex","modelValue"])]),_:1},8,["modelValue","tabs"]),o(ze,{side:"right",class:"flex flex-col justify-between border-l"},{default:i(()=>{var n;return[c("div",{class:"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium",onClick:e[5]||(e[5]=l=>t(aa)(t(s).data.name))},b(a.__(t(s).data.name)),1),c("div",_a,[o(t(z),{text:a.__("Organization logo")},{default:i(()=>{var l,k;return[c("div",fa,[o(t(te),{size:"3xl",class:"size-12",label:((l=w.value)==null?void 0:l.name)||a.__("Untitled"),image:(k=w.value)==null?void 0:k.organization_logo},null,8,["label","image"])])]}),_:1},8,["text"]),c("div",ga,[o(t(z),{text:((n=w.value)==null?void 0:n.name)||a.__("Set an organization")},{default:i(()=>{var l;return[c("div",va,b(((l=w.value)==null?void 0:l.name)||a.__("Untitled")),1)]}),_:1},8,["text"]),c("div",ya,[t(le)?(r(),g(t(z),{key:0,text:a.__("Make a call")},{default:i(()=>[o(m,{class:"h-7 w-7",onClick:ke},{default:i(()=>[o(O,{class:"h-4 w-4"})]),_:1})]),_:1},8,["text"])):_("",!0),o(t(z),{text:a.__("Send an email")},{default:i(()=>[o(m,{class:"h-7 w-7"},{default:i(()=>[o(ee,{class:"h-4 w-4",onClick:e[6]||(e[6]=l=>t(s).data.email?Ie():t(A)(a.__("No email set")))})]),_:1})]),_:1},8,["text"]),o(t(z),{text:a.__("Go to website")},{default:i(()=>[o(m,{class:"h-7 w-7"},{default:i(()=>[o(De,{class:"h-4 w-4",onClick:e[7]||(e[7]=l=>t(s).data.website?t(ta)(t(s).data.website):t(A)(a.__("No website set")))})]),_:1})]),_:1},8,["text"])])])]),t(s).data.sla_status?(r(),g(Ae,{key:0,modelValue:t(s).data,"onUpdate:modelValue":e[8]||(e[8]=l=>t(s).data=l),onUpdateField:I},null,8,["modelValue"])):_("",!0),t(L).data?(r(),p("div",xa,[c("div",ha,[(r(!0),p(q,null,oe(t(L).data,(l,k)=>(r(),p("div",{key:l.label,class:N(["flex flex-col p-3",{"border-b":k!==t(L).data.length-1}])},[o(ae,{"is-opened":l.opened,label:l.label},{actions:i(()=>[l.contacts?(r(),p("div",ba,[o(Xe,{value:"",doctype:"Contact",onChange:e[9]||(e[9]=y=>G(y)),onCreate:(y,V)=>{W.value={first_name:y,company_name:t(s).data.organization},F.value=!0,V()}},{target:i(({togglePopover:y})=>[o(m,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:V=>y()},null,8,["onClick"])]),_:1},8,["onCreate"])])):(!l.contacts&&k==1||k==0)&&t(_e)()?(r(),g(m,{key:1,variant:"ghost",class:"w-7 mr-2",onClick:e[10]||(e[10]=y=>U.value=!0)},{default:i(()=>[o(Be,{class:"h-4 w-4"})]),_:1})):_("",!0)]),default:i(()=>{var y,V,K,J,Q;return[l.fields?(r(),g(Me,{key:0,fields:l.fields,modelValue:t(s).data,"onUpdate:modelValue":e[11]||(e[11]=u=>t(s).data=u),onUpdate:I},null,8,["fields","modelValue"])):(r(),p("div",Ca,[(y=t(v))!=null&&y.loading&&((K=(V=t(v))==null?void 0:V.data)==null?void 0:K.length)==0?(r(),p("div",ka,[o(Ne,{class:"h-4 w-4"}),c("span",null,b(a.__("Loading...")),1)])):(Q=(J=t(v))==null?void 0:J.data)!=null&&Q.length?(r(!0),p(q,{key:1},oe(t(v).data,(u,X)=>(r(),p("div",{key:u.name},[c("div",{class:N(["px-2 pb-2.5",[X==0?"pt-5":"pt-2.5"]])},[o(ae,{"is-opened":u.opened},{header:i(({opened:Ve,toggle:Y})=>[c("div",wa,[c("div",{class:"flex h-7 items-center gap-2 truncate",onClick:Z=>Y()},[o(t(te),{label:u.full_name,image:u.image,size:"md"},null,8,["label","image"]),c("div",Va,b(u.full_name),1),u.is_primary?(r(),g(C,{key:0,class:"ml-2",variant:"outline",label:a.__("Primary"),theme:"green"},null,8,["label"])):_("",!0)],8,Ia),c("div",za,[o(t(ne),{options:he(u.name)},{default:i(()=>[o(m,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),o(m,{variant:"ghost",onClick:Z=>t(D).push({name:"Contact",params:{contactId:u.name}})},{default:i(()=>[o(Pe,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),o(m,{variant:"ghost",onClick:Z=>Y()},{default:i(()=>[o(d,{name:"chevron-right",class:N(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":Ve}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:i(()=>[c("div",$a,[c("div",Da,[o(ee,{class:"h-4 w-4"}),se(" "+b(u.email),1)]),c("div",Sa,[o(O,{class:"h-4 w-4"}),se(" "+b(u.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),X!=t(v).data.length-1?(r(),p("div",Ua)):_("",!0)]))),128)):(r(),p("div",Ea,b(a.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):_("",!0)]}),_:1})])):_("",!0),o(Ge,{modelValue:R.value,"onUpdate:modelValue":e[12]||(e[12]=n=>R.value=n),organization:T.value,"onUpdate:organization":e[13]||(e[13]=n=>T.value=n),options:{redirect:!1,afterInsert:n=>I("organization",n.name,()=>{t(me).reload()})}},null,8,["modelValue","organization","options"]),o(Qe,{modelValue:F.value,"onUpdate:modelValue":e[14]||(e[14]=n=>F.value=n),contact:W.value,options:{redirect:!1,afterInsert:n=>G(n.name)}},null,8,["modelValue","contact","options"]),S.value?(r(),g(He,{key:2,modelValue:S.value,"onUpdate:modelValue":e[15]||(e[15]=n=>S.value=n),assignees:t(s).data._assignedTo,"onUpdate:assignees":e[16]||(e[16]=n=>t(s).data._assignedTo=n),doc:t(s).data,doctype:"CRM Deal"},null,8,["modelValue","assignees","doc"])):_("",!0),U.value?(r(),g($e,{key:3,modelValue:U.value,"onUpdate:modelValue":e[17]||(e[17]=n=>U.value=n),doctype:"CRM Deal"},null,8,["modelValue"])):_("",!0)],64)}}};export{xt as default};
//# sourceMappingURL=Deal-f0948c27.js.map
